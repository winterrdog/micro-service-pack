generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

enum PaymentState {
  INITIATED
  PENDING
  SUCCESS
  FAILED
}

enum Currency {
  UGX
  USD
}

enum PaymentMethod {
  MOBILE_MONEY
}

model Payment {
  id            String        @id @default(uuid()) @db.Uuid
  reference     String        @unique
  amount        Decimal       @db.Decimal
  currency      Currency
  paymentMethod PaymentMethod
  customerPhone String
  customerEmail String?
  state         PaymentState  @default(INITIATED)
  providerName  String? // which provider we sent to (optional)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // relation: one-to-many provider transactions / webhook events
  providerTxns ProviderTransaction[]

  // convenient index for queries by phone/email
  @@index([customerPhone])
  @@index([customerEmail])
}

model ProviderTransaction {
  id                    String       @id @default(uuid()) @db.Uuid
  paymentId             String       @db.Uuid
  payment               Payment      @relation(fields: [paymentId], references: [id])
  providerName          String
  providerTransactionId String // the provider's transaction id (from webhook)
  status                PaymentState
  amount                Decimal      @db.Decimal
  currency              Currency
  receivedAt            DateTime     @default(now())
  createdAt             DateTime     @default(now())

  @@unique([providerName, providerTransactionId])
}

model WebhookDelivery {
  id           String    @id @default(uuid()) @db.Uuid
  providerName String
  providerTxId String
  payloadHash  String? // optional hash for additional idempotency
  processed    Boolean   @default(false)
  receivedAt   DateTime  @default(now())
  processedAt  DateTime?

  // make it unique so repeated deliveries are ignored
  @@unique([providerName, providerTxId])
}
